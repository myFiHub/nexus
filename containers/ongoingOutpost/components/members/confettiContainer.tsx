"use client";
import { confettiEventBus } from "app/containers/ongoingOutpost/eventBusses/confetti";
import { IncomingMessageType } from "app/services/wsClient";
import confetti from "canvas-confetti";
import { useEffect, useRef } from "react";
import { Subscription } from "rxjs";

// @ts-ignore
var heart = confetti.shapeFromPath({
  path: "M167 72c19,-38 37,-56 75,-56 42,0 76,33 76,75 0,76 -76,151 -151,227 -76,-76 -151,-151 -151,-227 0,-42 33,-75 75,-75 38,0 57,18 76,56z",
  matrix: [
    0.03333333333333333, 0, 0, 0.03333333333333333, -5.566666666666666,
    -5.533333333333333,
  ],
});

// @ts-ignore
var like = confetti.shapeFromPath({
  path: "M63.167 29.993c0,-2.827 -1.941,-5.688 -5.648,-5.688l-16.807 0c2.401,-4.295 3.107,-10.336 1.438,-14.756c-1.226,-3.251 -3.569,-5.148 -6.601,-5.341l-0.049 -0.004c-1.973,-0.121 -3.681 1.357 -3.845 3.327c-0.432 4.384 -2.353 12.138 -5.106 14.891c-2.318 2.318 -4.302 3.289 -7.591 4.897c-0.476 0.233 -0.996 0.487 -1.546 0.761c0.01 0.119 0.016 0.238 0.016 0.36l0 27.474c0.397 0.136 0.789 0.271 1.174 0.403c5.428 1.871 10.119 3.486 17.289 3.486l13.588 0c3.708 0 5.648 -2.862 5.648 -5.688c0,-0.839 -0.17,-1.68 -0.506,-2.45c1.235,-0.222 2.316,-0.816 3.117,-1.725c0.909,-1.033 1.41,-2.406 1.41,-3.866c0,-0.836 -0.17,-1.677 -0.506,-2.445c2.977,-0.514 4.527,-3.069 4.527,-5.595c0,-1.465 -0.522,-2.94 -1.54,-4.02c1.016,-1.08 1.539,-2.555 1.539,-4.02z",
  matrix: [0.02, 0, 0, 0.02, -1.26334, -0.59986],
});

// @ts-ignore
var dislike = confetti.shapeFromPath({
  path: "M88.931 17.007l0 32.639c0 3.903 -3.18 7.079 -7.079 7.079l-8.942 0c-6.194 11.814 -18.54 10.401 -23.383 36.497c-0.311 1.674 -1.931 2.752 -3.573 2.422c-7.271 -1.441 -12.055 -4.76 -14.217 -9.861c-2.19 -7.525 1.302 -16.973 5.532 -24.582l-12.188 0c-4.075 0 -8.164 -1.941 -10.671 -5.066c-2.014 -2.511 -2.765 -5.51 -2.11 -8.446l6.93 -30.796c1.673 -7.525 6.57 -12.197 12.785 -12.197l32.12 0c4.261 0 8.245 2.159 10.622 5.632l8.096 0c3.899 0 7.079 3.177 7.079 7.079z",
  matrix: [0.015, 0, 0, 0.015, -1.333965, -0.255092],
});

// @ts-ignore
var cheer = confetti.shapeFromPath({
  path: "M84.234 39.961c-3.331 0 -6.462 1.279 -8.847 3.593l-15.571 12.666c-1.911 -2.901 -4.193 -5.847 -6.762 -8.691c-2.764 -3.061 -5.625 -5.755 -8.435 -8.004l12.323 -15.15c2.314 -2.385 3.594 -5.516 3.594 -8.848c0 -3.397 -1.323 -6.592 -3.727 -8.995c-4.124 -4.123 -10.833 -4.122 -14.957 0.002c-3.455 3.455 -3.455 9.076 0 12.532c2.921 2.918 7.671 2.917 10.589 -0.001c2.492 -2.493 2.492 -6.546 0 -9.039c-0.781 -0.781 -2.048 -0.781 -2.828 0c-0.781 0.781 -0.781 2.047 0 2.828c0.932 0.932 0.932 2.449 0 3.381c-1.359 1.359 -3.573 1.359 -4.932 0c-0.918 -0.918 -1.424 -2.139 -1.424 -3.437c0 -1.298 0.506 -2.519 1.424 -3.437c2.563 -2.563 6.735 -2.564 9.301 -0.001c1.647 1.647 2.555 3.836 2.555 6.166c0 2.33 -0.908 4.519 -2.555 6.166c-0.024 0.024 -0.023 0.053 -0.046 0.079c-0.023 0.026 -0.051 0.046 -0.073 0.074l-12.473 15.29c-4.528 -3.108 -8.758 -4.891 -12.012 -4.891c-1.667 0 -3.05 0.467 -4.141 1.354c-0.072 0.048 -0.143 0.096 -0.208 0.153c-0.008 0.006 -0.017 0.011 -0.025 0.018c-0.772 0.697 -1.486 1.739 -1.821 3.272l-22.534 44.049c-0.085 0.166 -0.136 0.339 -0.171 0.513c-1.156 3.925 -0.226 8.064 2.523 11.108c2.251 2.493 5.355 3.854 8.613 3.854c0.731 0 1.471 -0.075 2.209 -0.215c0.167 -0.02 0.334 -0.053 0.498 -0.116l46.188 -17.969c1.194 -0.146 2.22 -0.562 3.067 -1.232c0.07 -0.043 0.133 -0.093 0.196 -0.144c0.031 -0.027 0.069 -0.047 0.1 -0.074c0.011 -0.01 0.021 -0.022 0.033 -0.032c0.013 -0.013 0.026 -0.026 0.039 -0.04c1.789 -1.674 3.226 -5.207 0.163 -12.588c-0.601 -1.447 -1.352 -2.952 -2.212 -4.485l15.999 -13.015c0.027 -0.022 0.048 -0.05 0.074 -0.074c0.025 -0.023 0.054 -0.04 0.078 -0.064c1.646 -1.646 3.836 -2.554 6.165 -2.554c2.329 0 4.519 0.908 6.166 2.554c3.563 3.563 3.563 9.735 0 13.299c-0.919 0.919 -2.14 1.425 -3.438 1.425c-1.298 0 -2.519 -0.506 -3.438 -1.425c-1.359 -1.359 -1.359 -3.573 0 -4.932c0.904 -0.904 2.478 -0.905 3.382 -0.001c0.781 0.781 2.048 0.781 2.829 0c0.781 -0.781 0.781 -2.047 0 -2.828c-2.492 -2.492 -6.547 -2.493 -9.039 0c-2.917 2.917 -2.917 7.667 0 10.586c1.674 1.674 3.898 2.597 6.266 2.597c2.368 0 4.592 -0.923 6.266 -2.597c4.123 -4.123 4.123 -10.832 0 -14.955c-2.401 -2.401 -5.595 -3.724 -8.993 -3.724zM24.787 46.43c2.16 5.203 6.093 11.106 11.076 16.623c5.859 6.49 12.156 11.366 17.463 13.72l-15.596 6.068c-11.08 -0.19 -20.873 -10.026 -21.115 -22.188l8.376 -16.373c0.224 0.682 0.48 1.391 0.796 2.15zM5.988 90.029c-1.815 -2.011 -2.426 -4.746 -1.65 -7.334l8.103 -15.838c2.306 8.988 9.167 16.15 17.946 18.84l-17.272 6.721c-2.653 0.507 -5.312 -0.378 -7.127 -2.389zM60.435 65.686c1.845 4.444 1.677 6.993 0.935 7.957l-1.778 0.692c-0.025 0 -0.046 0.004 -0.071 0.004c-4.015 0 -12.41 -4.797 -20.688 -14.967c-4.685 -5.187 -8.36 -10.683 -10.35 -15.476c-1.287 -3.099 -1.59 -5.271 -1.409 -6.639l0.858 -1.678c0.358 -0.219 0.845 -0.336 1.466 -0.336c2.136 0 5.52 1.372 9.46 4.026l-4.118 5.063c-0.657 0.857 -0.527 2.117 0.33 2.814c0.371 0.302 0.817 0.448 1.261 0.448c0.581 0 1.157 -0.252 1.553 -0.738l4.243 -4.756c2.575 2.048 5.293 4.57 8.001 7.569c2.54 2.813 4.77 5.716 6.608 8.55l-4.79 3.896c-0.857 0.697 -0.987 1.957 -0.29 2.814c0.396 0.486 0.972 0.738 1.553 0.738c0.443 0 0.891 -0.146 1.261 -0.448l4.34 -3.53c0.636 1.182 1.201 2.34 1.665 3.458z",
  matrix: [0.012, 0, 0, 0.012, -1.010808, -0.479532],
});

// @ts-ignore
var boo = confetti.shapeFromPath({
  path: "M13 13c-2.757 0 -5 2.243 -5 5c0 2.757 2.243 5 5 5c2.757 0 5 -2.243 5 -5c0 -2.757 -2.243 -5 -5 -5l0 0zM13 21c-1.657 0 -3 -1.343 -3 -3c0 -1.657 1.343 -3 3 -3c1.657 0 3 1.343 3 3c0 1.657 -1.343 3 -3 3l0 0zM31 13c-2.757 0 -5 2.243 -5 5c0 2.757 2.243 5 5 5c2.757 0 5 -2.243 5 -5c0 -2.757 -2.243 -5 -5 -5l0 0zM31 21c-1.657 0 -3 -1.343 -3 -3c0 -1.657 1.343 -3 3 -3c1.657 0 3 1.343 3 3c0 1.657 -1.343 3 -3 3l0 0zM22 0c-12.131 0 -22 9.869 -22 22c0 12.131 9.869 22 22 22c12.131 0 22 -9.869 22 -22c0 -12.131 -9.869 -22 -22 -22l0 0zM23.948 11.258l6.381 -5.77c0.41 -0.369 1.041 -0.338 1.413 0.072c0.37 0.41 0.338 1.042 -0.071 1.413l-6.381 5.769c-0.191 0.173 -0.432 0.258 -0.671 0.258c-0.272 0 -0.544 -0.111 -0.742 -0.329c-0.37 -0.41 -0.338 -1.042 0.071 -1.413l0 0zM12.258 5.56c0.373 -0.41 1.004 -0.441 1.413 -0.072l7.723 5.698c0.41 0.371 0.442 1.003 0.072 1.413c-0.198 0.218 -0.47 0.329 -0.742 0.329c-0.239 0 -0.48 -0.085 -0.671 -0.258l-6.381 -5.769c-0.41 -0.371 -0.442 -1.003 -0.072 -1.413l0 0zM6 18c0 -3.859 3.141 -7 7 -7c3.859 0 7 3.141 7 7c0 3.859 -3.141 7 -7 7c-3.859 0 -7 -3.141 -7 -7l0 0zM22 38c-3.309 0 -6 -2.691 -6 -6c0 -3.309 2.691 -6 6 -6c3.309 0 6 2.691 6 6c0 3.309 -2.691 6 -6 6l0 0zM31 25c-3.859 0 -7 -3.141 -7 -7c0 -3.859 3.141 -7 7 -7c3.859 0 7 3.141 7 7c0 3.859 -3.141 7 -7 7l0 0z",
  matrix: [0.025, 0, 0, 0.025, -1.1, -0.55],
});

const likeColors = ["#4CAF50", "#45a049", "#66BB6A"];
const dislikeColors = ["#f44336", "#d32f2f", "#ef5350"];
const cheerColors = ["#4CAF50", "#45a049", "#66BB6A"];
const booColors = ["#f44336", "#d32f2f", "#ef5350"];
const heartColors = ["#f93963", "#a10864", "#ee0b93"];

function randomInRange(min: number, max: number) {
  return Math.random() * (max - min) + min;
}

var defaults: confetti.Options = {
  angle: randomInRange(55, 125),
  particleCount: 5,
  scalar: 45,

  spread: 360,
  ticks: 50,
  decay: 0.94,
  startVelocity: 5,

  //   decay: 0.1,
};

export const ConfettiContainer = ({ address }: { address: string }) => {
  const canvasRef = useRef<HTMLCanvasElement | null>(null);
  // Event tracking for special effects - persist across renders

  function getConfettiConfig(type: IncomingMessageType): {
    shapes: any[];
    colors: string[];
    gravity: number;
  } {
    switch (type) {
      case IncomingMessageType.USER_LIKED:
        return { shapes: [like, "star"], colors: likeColors, gravity: -1 };
      case IncomingMessageType.USER_DISLIKED:
        return {
          shapes: [dislike, "star"],
          colors: dislikeColors,
          gravity: 1,
        };
      case IncomingMessageType.USER_CHEERED:
        return { shapes: [cheer, "star"], colors: cheerColors, gravity: -1 };
      case IncomingMessageType.USER_BOOED:
        return { shapes: [boo, "star"], colors: booColors, gravity: 1 };
      default:
        return { shapes: [heart], colors: heartColors, gravity: 1 };
    }
  }

  useEffect(() => {
    let subscription: Subscription;
    if (address) {
      subscription = confettiEventBus.subscribe(({ address, type }) => {
        //

        if (address === address) {
          const shoot = () => {
            const canvas = canvasRef.current!;

            const canvasConfetti = confetti.create(canvas, {
              resize: false,
              useWorker: false,
            });

            // If special effect should be triggered, do that instead

            const { shapes, colors, gravity } = getConfettiConfig(type);

            canvasConfetti({
              ...defaults,
              gravity,
              shapes,
              colors,
            });
          };
          shoot();
        }
      });
    }
    return () => {
      subscription?.unsubscribe();
    };
  }, [address]);

  return (
    <div className="absolute top-0 left-0 w-full h-full pointer-events-none">
      <canvas
        ref={canvasRef}
        className="absolute top-0 left-0 w-full h-full pointer-events-none"
      />
    </div>
  );
};
